<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5899C1DJM0"></script>

  <title>Marble Roulette</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="apple-touch-icon" sizes="57x57" href="assets/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="assets/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="assets/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="assets/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="assets/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="assets/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="assets/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="assets/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="assets/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="assets/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
  <link rel="manifest" href="assets/manifest.json">

  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="assets/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <meta name="description" content="A lucky draw by dropping marbles, made by lazygyu">
  <meta property="og:url" content="https://lazygyu.github.io/roulette/">
  <meta property="og:title" content="Marble Roulette">
  <meta property="og:description" content="A lucky draw by dropping marbles, made by lazygyu">
  <meta property="og:site_name" content="lazygyu.github.io">
  <meta property="og:type" content="website">

  <link rel='stylesheet' href='assets/style.scss' />
</head>
<body>
<script type="module" src="./src/index.ts"></script>
<script type="text/javascript">
  window.dataLayer = window.dataLayer || [];

  function gtag() {
    dataLayer.push(arguments);
  }

  gtag('js', new Date());
  gtag('config', 'G-5899C1DJM0');

  function getNames() {
    const blocks = document.querySelectorAll('#names-container .name-block');
    return Array.from(blocks).map(block => block.dataset.name).filter(v => !!v);
  }

  // ì´ë¦„ ë¸”ë¡ ìƒì„±
  function createNameBlock(name) {
    const block = document.createElement('div');
    block.className = 'name-block';
    block.dataset.name = name;
    
    const nameSpan = document.createElement('span');
    nameSpan.className = 'block-name';
    nameSpan.textContent = name;
    
    const removeBtn = document.createElement('button');
    removeBtn.className = 'block-remove';
    removeBtn.innerHTML = 'Ã—';
    removeBtn.addEventListener('click', () => {
      block.remove();
      saveNamesToStorage();
      getReady();
    });
    
    block.appendChild(nameSpan);
    block.appendChild(removeBtn);
    return block;
  }

  // ì´ë¦„ ë¸”ë¡ ì¶”ê°€
  function addNameBlock(name) {
    const container = document.querySelector('#names-container');
    const block = createNameBlock(name);
    container.appendChild(block);
  }

  // ì €ì¥ì†Œì— ì´ë¦„ ì €ì¥
  function saveNamesToStorage() {
    const names = getNames();
    localStorage.setItem('mbr_names', names.join(','));
  }

  // ì €ì¥ì†Œì—ì„œ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadNamesFromStorage(namesStr) {
    const container = document.querySelector('#names-container');
    container.innerHTML = '';
    
    if (!namesStr) return;
    
    const names = namesStr.split(/[,\r\n]/g).map(v => v.trim()).filter(v => !!v);
    names.forEach(name => addNameBlock(name));
  }

  function parseName(nameStr) {
    const weightRegex = /(\/\d+)/;
    const countRegex = /(\*\d+)/;
    const hasWeight = weightRegex.test(nameStr);
    const hasCount = countRegex.test(nameStr);
    const name = /^\s*([^\/*]+)?/.exec(nameStr)[1];
    const weight = hasWeight ? parseInt(weightRegex.exec(nameStr)[1].replace('/', '')) : 1;
    const count = hasCount ? parseInt(countRegex.exec(nameStr)[1].replace('*', '')) : 1;
    return {
      name,
      weight,
      count,
    };
  }

  function getReady() {
    const names = getNames();
    window.roulette.setMarbles(names);
    ready = names.length > 0;
    localStorage.setItem('mbr_names', names.join(','));
    switch (winnerType) {
      case 'first':
        setWinnerRank(1);
        break;
      case 'last':
        const total = window.roulette.getCount();
        setWinnerRank(total);
        break;
    }
  }

  function setWinnerRank(rank) {
    document.querySelector('#in_winningRank').value = rank;
    window.options.winningRank = rank - 1;
    window.roulette.setWinningRank(window.options.winningRank);

    if (winnerType === 'first') {
      document.querySelector('.btn-first-winner').classList.toggle('active', true);
      document.querySelector('.btn-last-winner').classList.toggle('active', false);
      document.querySelector('#in_winningRank').classList.toggle('active', false);
    } else if (winnerType === 'last') {
      document.querySelector('.btn-first-winner').classList.toggle('active', false);
      document.querySelector('.btn-last-winner').classList.toggle('active', true);
      document.querySelector('#in_winningRank').classList.toggle('active', false);
    } else if (winnerType === 'custom') {
      document.querySelector('.btn-first-winner').classList.toggle('active', false);
      document.querySelector('.btn-last-winner').classList.toggle('active', false);
      document.querySelector('#in_winningRank').classList.toggle('active', true);
    }
  }


  let ready = false;
  let winnerType = 'first';

  document.addEventListener('DOMContentLoaded', () => {
    initialize();
  });

  function initialize() {
    if (!window.roulette || !window.roulette.isReady) {
      console.log('does not loaded yet');
      setTimeout(initialize, 100);
      return;
    }
    console.log('initializing start');

    const urlParams = new URLSearchParams(window.location.search);
    const namesFromUrl = urlParams.get('names');

    if (namesFromUrl) {
      loadNamesFromStorage(namesFromUrl);
    } else {
      const savedNames = localStorage.getItem('mbr_names');
      if (savedNames) {
        loadNamesFromStorage(savedNames);
      }
    }

    // ì´ë¦„ ì…ë ¥ í•„ë“œì—ì„œ Enter í‚¤ë¡œ ì¶”ê°€
    document.querySelector('#name-add-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const input = e.target;
        const value = input.value.trim();
        if (value) {
          // ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì—¬ëŸ¬ ì´ë¦„ ì²˜ë¦¬
          const names = value.split(/[,\r\n]/g).map(v => v.trim()).filter(v => !!v);
          names.forEach(name => addNameBlock(name));
          input.value = '';
          saveNamesToStorage();
          getReady();
        }
      }
    });

    // ì „ì²´ ì‚­ì œ ë²„íŠ¼
    document.querySelector('#clear-all-names').addEventListener('click', () => {
      document.querySelector('#names-container').innerHTML = '';
      saveNamesToStorage();
      getReady();
    });

    // ë¦¬ì…‹ ë²„íŠ¼ - ëª¨ë“  ì´ë¦„ ë¸”ë¡ ì‚­ì œ
    document.querySelector('#btnReset').addEventListener('click', () => {
      document.querySelector('#names-container').innerHTML = '';
      saveNamesToStorage();
      getReady();
    });

    document.querySelector('#btnShuffle').addEventListener('click', () => {
      getReady();
    });

    document.querySelector('#btnStart').addEventListener('click', () => {
      if (!ready) return;
      gtag && gtag('event', 'start', {
        'event_category': 'roulette',
        'event_label': 'start',
        'value': window.roulette.getCount(),
      });
      window.roulette.start();
      document.querySelector('#settings').classList.add('hide');
      document.querySelector('#donate').classList.add('hide');
    });

    document.querySelector('#chkAutoRecording').addEventListener('change', (e) => {
      window.options.autoRecording = e.target.matches(':checked');
      window.roulette.setAutoRecording(window.options.autoRecording);
    });

    document.querySelector('#chkSkill').addEventListener('change', (e) => {
      window.options.useSkills = e.target.matches(':checked');
      window.roulette.setWinningRank(window.options.winningRank);
    });

    document.querySelector('#chkDarkMode').addEventListener('change', (e) => {
      window.options.darkMode = e.target.matches(':checked');
      window.roulette.setTheme(window.options.darkMode ? 'dark' : 'light');
      document.documentElement.classList.toggle('light', !window.options.darkMode);
    });

    document.querySelector('#in_winningRank').addEventListener('change', (e) => {
      const v = parseInt(e.target.value, 10);
      winnerType = 'custom';
      setWinnerRank(isNaN(v) ? 0 : v);
    });

    document.querySelector('.btn-last-winner').addEventListener('click', () => {
      const total = window.roulette.getCount();
      winnerType = 'last';
      setWinnerRank(total);
    });
    document.querySelector('.btn-first-winner').addEventListener('click', () => {
      winnerType = 'first';
      setWinnerRank(1);
    });

    window.roulette.addEventListener('goal', () => {
      ready = false;
      setTimeout(() => {
        document.querySelector('#settings').classList.remove('hide');
        document.querySelector('#donate').classList.remove('hide');
      }, 3000);
    });

    window.roulette.addEventListener('message', (e) => {
      simpleToast(e.detail);
    });

    document.querySelector('#btnShuffle').click();

    const maps = window.roulette.getMaps();
    const mapSelector = document.querySelector('#sltMap');
    maps.forEach((map) => {
      const option = document.createElement('option');
      option.value = map.index;
      option.innerHTML = map.title;
      option.setAttribute('data-trans', '');
      window.translateElement(option);
      mapSelector.append(option);
    });
    mapSelector.addEventListener('change', (e) => {
      const index = e.target.value;
      window.roulette.setMap(index);
    });

    const checkDonateButtonLoaded = () => {
      const btn = document.querySelector('span.bmc-btn-text');
      if (!btn) {
        setTimeout(checkDonateButtonLoaded, 100);
      } else {
        console.log('donation button has been loaded');
        btn.setAttribute('data-trans', '');
        window.translateElement(btn);
      }
    };
    setTimeout(checkDonateButtonLoaded, 100);

    const currentNotice = 3;
    const noticeKey = 'lastViewedNotification';

    const closeNotice = () => {
      document.querySelector('#notice').style.display = 'none';
      localStorage.setItem(noticeKey, currentNotice.toString());
    };

    const openNotice = () => {
      console.log('openNotice');
      document.querySelector('#notice').style.display = 'flex';
    };

    document.querySelector('#closeNotice').addEventListener('click', () => {
      closeNotice();
    });

    document.querySelector('#btnNotice').addEventListener('click', () => {
      openNotice();
    });

    function simpleToast(msg) {
      const toast = document.createElement('div');
      toast.classList.add('toast');
      toast.innerHTML = msg;

      if (window.translateElement) {
        console.log('try to translate');
        window.translateElement(toast);
      }

      document.body.appendChild(toast);
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 1200);
    }

    const checkNotice = () => {
      const lastViewed = localStorage.getItem(noticeKey);
      console.log('lastViewed', lastViewed);
      if (lastViewed === null || Number(lastViewed) < currentNotice) {
        openNotice();
      }
    };

    // checkNotice(); // ë…¸í‹°ìŠ¤ íŒì—… ë¹„í™œì„±í™”

    // ========== ì»¤ìŠ¤í…€ ëª¨ë‹¬ ì‹œìŠ¤í…œ ==========
    const modal = {
      element: null,
      titleEl: null,
      messageEl: null,
      inputArea: null,
      inputEl: null,
      confirmBtn: null,
      cancelBtn: null,
      currentResolve: null,

      init() {
        this.element = document.querySelector('#custom-modal');
        this.titleEl = document.querySelector('#modal-title');
        this.messageEl = document.querySelector('#modal-message');
        this.inputArea = document.querySelector('#modal-input-area');
        this.inputEl = document.querySelector('#modal-input');
        this.confirmBtn = document.querySelector('#modal-confirm-btn');
        this.cancelBtn = document.querySelector('#modal-cancel-btn');

        this.confirmBtn.addEventListener('click', () => this.handleConfirm());
        this.cancelBtn.addEventListener('click', () => this.handleCancel());
        this.element.querySelector('.modal-backdrop').addEventListener('click', () => this.handleCancel());
        this.inputEl.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.handleConfirm();
        });
      },

      show(type, title, message, defaultValue = '') {
        return new Promise((resolve) => {
          this.currentResolve = resolve;
          this.titleEl.textContent = title;
          this.messageEl.textContent = message;

          // íƒ€ì…ë³„ ì„¤ì •
          if (type === 'alert') {
            this.inputArea.style.display = 'none';
            this.cancelBtn.style.display = 'none';
          } else if (type === 'confirm') {
            this.inputArea.style.display = 'none';
            this.cancelBtn.style.display = 'block';
          } else if (type === 'prompt') {
            this.inputArea.style.display = 'block';
            this.cancelBtn.style.display = 'block';
            this.inputEl.value = defaultValue;
            setTimeout(() => this.inputEl.focus(), 100);
          }

          this.element.classList.add('show');
        });
      },

      handleConfirm() {
        const isPrompt = this.inputArea.style.display !== 'none';
        const value = isPrompt ? this.inputEl.value : true;
        this.element.classList.remove('show');
        if (this.currentResolve) {
          this.currentResolve(value);
          this.currentResolve = null;
        }
      },

      handleCancel() {
        this.element.classList.remove('show');
        if (this.currentResolve) {
          this.currentResolve(null);
          this.currentResolve = null;
        }
      },

      alert(message, title = 'ì•Œë¦¼') {
        return this.show('alert', title, message);
      },

      confirm(message, title = 'í™•ì¸') {
        return this.show('confirm', title, message);
      },

      prompt(message, defaultValue = '', title = 'ì…ë ¥') {
        return this.show('prompt', title, message, defaultValue);
      }
    };

    // ========== í•™ìƒ ê´€ë¦¬ íŒ¨ë„ ê¸°ëŠ¥ ==========
    const STUDENT_DATA_KEY = 'mbr_student_data';
    
    // ê¸°ë³¸ ë°ì´í„° êµ¬ì¡°
    function getDefaultData() {
      return {
        classes: [],
        parts: [
          { name: 'íŒŒíŠ¸ A', min: 1, max: 15 },
          { name: 'íŒŒíŠ¸ B', min: 16, max: 30 },
          { name: 'íŒŒíŠ¸ C', min: 31, max: 50 }
        ],
        expandedClassIndices: [],  // í¼ì³ì§„ ë°˜ë“¤ì˜ ì¸ë±ìŠ¤ ë°°ì—´
        addToClassIndex: -1        // í•™ìƒ ì¶”ê°€í•  ë°˜ ì¸ë±ìŠ¤
      };
    }

    // ë°ì´í„° ë¡œë“œ
    function loadData() {
      const saved = localStorage.getItem(STUDENT_DATA_KEY);
      if (saved) {
        const data = JSON.parse(saved);
        if (!data.parts) data.parts = getDefaultData().parts;
        if (!data.classes) data.classes = [];
        // ì´ì „ ë°ì´í„° êµ¬ì¡° í˜¸í™˜
        if (!data.expandedClassIndices) {
          data.expandedClassIndices = data.selectedClassIndex >= 0 ? [data.selectedClassIndex] : [];
        }
        if (data.addToClassIndex === undefined) data.addToClassIndex = -1;
        return data;
      }
      return getDefaultData();
    }

    // ë°ì´í„° ì €ì¥
    function saveData(data) {
      localStorage.setItem(STUDENT_DATA_KEY, JSON.stringify(data));
    }

    // ì´ë¦„ì„ ì…ë ¥ë€ì— ì¶”ê°€ (ë¸”ë¡ ë°©ì‹)
    function addNameToInput(name) {
      addNameBlock(name);
      saveNamesToStorage();
      getReady();
    }

    // ì—¬ëŸ¬ ì´ë¦„ì„ ì…ë ¥ë€ì— ì¶”ê°€ (ë¸”ë¡ ë°©ì‹)
    function addNamesToInput(names) {
      names.forEach(name => addNameBlock(name));
      saveNamesToStorage();
      getReady();
    }

    // í•™ìƒì´ ì†í•œ íŒŒíŠ¸ ì°¾ê¸°
    function findPartForValue(value, parts) {
      for (let i = 0; i < parts.length; i++) {
        if (value >= parts[i].min && value <= parts[i].max) {
          return i;
        }
      }
      return -1;
    }

    // ë°˜ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë Œë”ë§
    function renderClassSelect() {
      const data = loadData();
      const select = document.querySelector('#student-class-select');
      select.innerHTML = '<option value="">-- ë°˜ ì„ íƒ --</option>';
      
      data.classes.forEach((cls, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = cls.name;
        if (index === data.addToClassIndex) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    }

    // ë°˜ ê´€ë¦¬ íƒ­: ì•„ì½”ë””ì–¸ ìŠ¤íƒ€ì¼ ë°˜ë³„ ëª©ë¡
    function renderStudentsList() {
      const data = loadData();
      const container = document.querySelector('#students-list');
      container.innerHTML = '';

      // ë°˜ ì„ íƒ ë“œë¡­ë‹¤ìš´ë„ ì—…ë°ì´íŠ¸
      renderClassSelect();

      if (data.classes.length === 0) {
        container.innerHTML = '<div class="no-class-selected">ë°˜ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>';
        return;
      }

      // ê° ë°˜ì„ ì•„ì½”ë””ì–¸ìœ¼ë¡œ ë Œë”ë§
      data.classes.forEach((cls, classIndex) => {
        const students = cls.students || [];
        const isExpanded = data.expandedClassIndices.includes(classIndex);
        
        const classAccordion = document.createElement('div');
        classAccordion.className = `class-accordion ${isExpanded ? 'expanded' : ''}`;
        
        // ë°˜ í—¤ë” (í´ë¦­í•˜ì—¬ í¼ì¹¨/ì ‘í˜)
        const header = document.createElement('div');
        header.className = 'class-accordion-header';
        header.innerHTML = `
          <span class="accordion-icon">${isExpanded ? 'â–¼' : 'â–¶'}</span>
          <span class="class-name">${cls.name}</span>
          <span class="student-count">${students.length}ëª…</span>
          <button class="delete-class-btn" title="ë°˜ ì‚­ì œ">Ã—</button>
        `;
        
        // í—¤ë” í´ë¦­ ì‹œ í¼ì¹¨/ì ‘í˜ (í† ê¸€)
        header.addEventListener('click', (e) => {
          if (e.target.classList.contains('delete-class-btn')) return;
          
          const data = loadData();
          const idx = data.expandedClassIndices.indexOf(classIndex);
          if (idx >= 0) {
            data.expandedClassIndices.splice(idx, 1); // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
          } else {
            data.expandedClassIndices.push(classIndex); // ì—´ê¸°
          }
          saveData(data);
          renderStudentsList();
        });
        
        // ë°˜ ì‚­ì œ ë²„íŠ¼
        header.querySelector('.delete-class-btn').addEventListener('click', async (e) => {
          e.stopPropagation();
          const confirmed = await modal.confirm(`"${cls.name}" ë°˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  í•™ìƒ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.`, 'ë°˜ ì‚­ì œ');
          if (!confirmed) return;
          
          const data = loadData();
          data.classes.splice(classIndex, 1);
          // í¼ì³ì§„ ì¸ë±ìŠ¤ ì •ë¦¬
          data.expandedClassIndices = data.expandedClassIndices
            .filter(i => i !== classIndex)
            .map(i => i > classIndex ? i - 1 : i);
          // ì¶”ê°€í•  ë°˜ ì¸ë±ìŠ¤ ì •ë¦¬
          if (data.addToClassIndex === classIndex) {
            data.addToClassIndex = -1;
          } else if (data.addToClassIndex > classIndex) {
            data.addToClassIndex--;
          }
          saveData(data);
          renderStudentsList();
          renderStudentsByParts();
        });

        classAccordion.appendChild(header);

        // í•™ìƒ ëª©ë¡ (í¼ì³ì§„ ê²½ìš°ì—ë§Œ)
        if (isExpanded) {
          const content = document.createElement('div');
          content.className = 'class-accordion-content';
          
          if (students.length === 0) {
            content.innerHTML = '<div class="no-students">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>';
          } else {
            const listDiv = document.createElement('div');
            listDiv.className = 'simple-student-list';

            students.forEach((student, studentIndex) => {
              const studentItem = document.createElement('div');
              studentItem.className = 'student-item';
              studentItem.innerHTML = `
                <span class="student-name">${student.name}</span>
                <span class="student-value" data-value="${student.value}" title="í´ë¦­í•˜ì—¬ ìˆ«ì ìˆ˜ì •">${student.value}</span>
                <button class="add-one-btn" title="ì…ë ¥ë€ì— ì¶”ê°€">+</button>
                <button class="edit-btn" title="ì´ë¦„ ìˆ˜ì •">âœ</button>
                <button class="delete-btn" title="ì‚­ì œ">Ã—</button>
              `;

              // ìˆ«ì ì¸ë¼ì¸ í¸ì§‘
              const valueSpan = studentItem.querySelector('.student-value');
              valueSpan.addEventListener('click', (e) => {
                e.stopPropagation();
                const originalValue = valueSpan.dataset.value;
                
                if (valueSpan.querySelector('input')) return;
                
                let saved = false;  // ì €ì¥ ì—¬ë¶€ í”Œë˜ê·¸
                
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'inline-value-input';
                input.value = '';
                input.placeholder = originalValue;
                
                valueSpan.textContent = '';
                valueSpan.appendChild(input);
                input.focus();
                
                const saveValue = () => {
                  if (saved) return;
                  const newValue = parseInt(input.value);
                  if (!isNaN(newValue)) {
                    saved = true;
                    const data = loadData();
                    data.classes[classIndex].students[studentIndex].value = newValue;
                    saveData(data);
                    renderStudentsList();
                    renderStudentsByParts();
                  } else {
                    valueSpan.textContent = originalValue;
                    valueSpan.dataset.value = originalValue;
                  }
                };
                
                input.addEventListener('keypress', (ev) => {
                  if (ev.key === 'Enter') {
                    saveValue();
                  }
                });
                
                input.addEventListener('keydown', (ev) => {
                  if (ev.key === 'Escape') {
                    saved = true;  // blurì—ì„œ ë³µì› ì•ˆë˜ê²Œ
                    valueSpan.textContent = originalValue;
                    valueSpan.dataset.value = originalValue;
                  }
                });
                
                input.addEventListener('blur', () => {
                  if (!saved) {
                    valueSpan.textContent = originalValue;
                    valueSpan.dataset.value = originalValue;
                  }
                });
              });

              // ê°œë³„ ì¶”ê°€
              studentItem.querySelector('.add-one-btn').addEventListener('click', () => {
                addNameToInput(student.name);
              });

              // ì´ë¦„ ìˆ˜ì •
              studentItem.querySelector('.edit-btn').addEventListener('click', async () => {
                const newName = await modal.prompt('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', student.name, 'ì´ë¦„ ìˆ˜ì •');
                if (newName === null || !newName.trim()) return;
                
                const data = loadData();
                data.classes[classIndex].students[studentIndex].name = newName.trim();
                saveData(data);
                renderStudentsList();
                renderStudentsByParts();
              });

              // ì‚­ì œ
              studentItem.querySelector('.delete-btn').addEventListener('click', async () => {
                const confirmed = await modal.confirm(`"${student.name}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 'í•™ìƒ ì‚­ì œ');
                if (!confirmed) return;
                
                const data = loadData();
                data.classes[classIndex].students.splice(studentIndex, 1);
                saveData(data);
                renderStudentsList();
                renderStudentsByParts();
              });

              listDiv.appendChild(studentItem);
            });

            content.appendChild(listDiv);
          }

          classAccordion.appendChild(content);
        }

        container.appendChild(classAccordion);
      });
    }

    // íŒŒíŠ¸ ì„¤ì • íƒ­: ëª¨ë“  ë°˜ì˜ í•™ìƒì„ íŒŒíŠ¸ë³„ë¡œ ë¶„ë¥˜ í‘œì‹œ
    function renderStudentsByParts() {
      const data = loadData();
      const container = document.querySelector('#students-by-parts');
      container.innerHTML = '';

      // ëª¨ë“  ë°˜ì—ì„œ í•™ìƒ ìˆ˜ì§‘ (ë°˜ ì¸ë±ìŠ¤ì™€ í•™ìƒ ì¸ë±ìŠ¤ í¬í•¨)
      const allStudents = [];
      data.classes.forEach((cls, classIndex) => {
        (cls.students || []).forEach((student, studentIndex) => {
          allStudents.push({ ...student, className: cls.name, classIndex, studentIndex });
        });
      });

      if (allStudents.length === 0) {
        container.innerHTML = '<div class="no-class-selected">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      // íŒŒíŠ¸ë³„ë¡œ í•™ìƒ ë¶„ë¥˜
      const partGroups = {};
      const unclassified = [];

      data.parts.forEach((part, idx) => {
        partGroups[idx] = { part, students: [] };
      });

      allStudents.forEach(student => {
        const partIndex = findPartForValue(student.value, data.parts);
        if (partIndex >= 0) {
          partGroups[partIndex].students.push(student);
        } else {
          unclassified.push(student);
        }
      });

      // ê° íŒŒíŠ¸ ë Œë”ë§
      Object.keys(partGroups).forEach(partIdx => {
        const group = partGroups[partIdx];
        const partDiv = document.createElement('div');
        partDiv.className = 'part-group';
        
        const header = document.createElement('div');
        header.className = 'part-header';
        header.innerHTML = `
          <span class="part-title">${group.part.name} (${group.part.min}~${group.part.max})</span>
          <span class="part-count">${group.students.length}ëª…</span>
          <button class="add-part-to-input" title="ì´ íŒŒíŠ¸ ì „ì²´ ì¶”ê°€">â–¶</button>
        `;
        
        // íŒŒíŠ¸ ì „ì²´ ì¶”ê°€ ë²„íŠ¼
        header.querySelector('.add-part-to-input').addEventListener('click', async () => {
          const names = group.students.map(s => s.name);
          if (names.length > 0) {
            addNamesToInput(names);
          } else {
            await modal.alert('ì´ íŒŒíŠ¸ì— í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
          }
        });

        partDiv.appendChild(header);

        // í•™ìƒ ëª©ë¡
        const studentList = document.createElement('div');
        studentList.className = 'student-list';
        
        group.students.forEach(student => {
          const studentItem = document.createElement('div');
          studentItem.className = 'student-item';
          studentItem.innerHTML = `
            <span class="student-name">${student.name}</span>
            <span class="student-value" data-value="${student.value}" data-class-index="${student.classIndex}" data-student-index="${student.studentIndex}" title="í´ë¦­í•˜ì—¬ ìˆ«ì ìˆ˜ì •">${student.value}</span>
            <button class="add-one-btn" title="ì¶”ê°€">+</button>
          `;

          // ìˆ«ì ì¸ë¼ì¸ í¸ì§‘
          const valueSpan = studentItem.querySelector('.student-value');
          valueSpan.addEventListener('click', (e) => {
            e.stopPropagation();
            const originalValue = valueSpan.dataset.value;
            const classIdx = parseInt(valueSpan.dataset.classIndex);
            const studentIdx = parseInt(valueSpan.dataset.studentIndex);
            
            if (valueSpan.querySelector('input')) return;
            
            let saved = false;  // ì €ì¥ ì—¬ë¶€ í”Œë˜ê·¸
            
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'inline-value-input';
            input.value = '';
            input.placeholder = originalValue;
            
            valueSpan.textContent = '';
            valueSpan.appendChild(input);
            input.focus();
            
            const saveValue = () => {
              if (saved) return;
              const newValue = parseInt(input.value);
              if (!isNaN(newValue)) {
                saved = true;
                const data = loadData();
                data.classes[classIdx].students[studentIdx].value = newValue;
                saveData(data);
                renderStudentsList();
                renderStudentsByParts();
              } else {
                valueSpan.textContent = originalValue;
                valueSpan.dataset.value = originalValue;
              }
            };
            
            input.addEventListener('keypress', (ev) => {
              if (ev.key === 'Enter') {
                saveValue();
              }
            });
            
            input.addEventListener('keydown', (ev) => {
              if (ev.key === 'Escape') {
                saved = true;  // blurì—ì„œ ë³µì› ì•ˆë˜ê²Œ
                valueSpan.textContent = originalValue;
                valueSpan.dataset.value = originalValue;
              }
            });
            
            input.addEventListener('blur', () => {
              if (!saved) {
                valueSpan.textContent = originalValue;
                valueSpan.dataset.value = originalValue;
              }
            });
          });

          studentItem.querySelector('.add-one-btn').addEventListener('click', () => {
            addNameToInput(student.name);
          });

          studentList.appendChild(studentItem);
        });

        partDiv.appendChild(studentList);
        container.appendChild(partDiv);
      });

      // ë¯¸ë¶„ë¥˜ í•™ìƒ
      if (unclassified.length > 0) {
        const unclassifiedDiv = document.createElement('div');
        unclassifiedDiv.className = 'part-group unclassified';
        
        const header = document.createElement('div');
        header.className = 'part-header';
        header.innerHTML = `
          <span class="part-title">ë¯¸ë¶„ë¥˜</span>
          <span class="part-count">${unclassified.length}ëª…</span>
          <button class="add-part-to-input" title="ë¯¸ë¶„ë¥˜ ì „ì²´ ì¶”ê°€">â–¶</button>
        `;
        
        header.querySelector('.add-part-to-input').addEventListener('click', () => {
          addNamesToInput(unclassified.map(s => s.name));
        });

        unclassifiedDiv.appendChild(header);

        const studentList = document.createElement('div');
        studentList.className = 'student-list';
        
        unclassified.forEach(student => {
          const studentItem = document.createElement('div');
          studentItem.className = 'student-item';
          studentItem.innerHTML = `
            <span class="student-name">${student.name}</span>
            <span class="student-value" data-value="${student.value}" data-class-index="${student.classIndex}" data-student-index="${student.studentIndex}" title="í´ë¦­í•˜ì—¬ ìˆ«ì ìˆ˜ì •">${student.value}</span>
            <button class="add-one-btn" title="ì¶”ê°€">+</button>
          `;

          // ìˆ«ì ì¸ë¼ì¸ í¸ì§‘
          const valueSpan = studentItem.querySelector('.student-value');
          valueSpan.addEventListener('click', (e) => {
            e.stopPropagation();
            const originalValue = valueSpan.dataset.value;
            const classIdx = parseInt(valueSpan.dataset.classIndex);
            const studentIdx = parseInt(valueSpan.dataset.studentIndex);
            
            if (valueSpan.querySelector('input')) return;
            
            let saved = false;
            
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'inline-value-input';
            input.value = '';
            input.placeholder = originalValue;
            
            valueSpan.textContent = '';
            valueSpan.appendChild(input);
            input.focus();
            
            const saveValue = () => {
              if (saved) return;
              const newValue = parseInt(input.value);
              if (!isNaN(newValue)) {
                saved = true;
                const data = loadData();
                data.classes[classIdx].students[studentIdx].value = newValue;
                saveData(data);
                renderStudentsList();
                renderStudentsByParts();
              } else {
                valueSpan.textContent = originalValue;
                valueSpan.dataset.value = originalValue;
              }
            };
            
            input.addEventListener('keypress', (ev) => {
              if (ev.key === 'Enter') {
                saveValue();
              }
            });
            
            input.addEventListener('keydown', (ev) => {
              if (ev.key === 'Escape') {
                saved = true;
                valueSpan.textContent = originalValue;
                valueSpan.dataset.value = originalValue;
              }
            });
            
            input.addEventListener('blur', () => {
              if (!saved) {
                valueSpan.textContent = originalValue;
                valueSpan.dataset.value = originalValue;
              }
            });
          });

          studentItem.querySelector('.add-one-btn').addEventListener('click', () => {
            addNameToInput(student.name);
          });
          studentList.appendChild(studentItem);
        });
        
        unclassifiedDiv.appendChild(studentList);
        container.appendChild(unclassifiedDiv);
      }
    }

    // íŒŒíŠ¸ ì„¤ì • ë Œë”ë§
    function renderParts() {
      const data = loadData();
      const container = document.querySelector('#parts-list');
      container.innerHTML = '';

      data.parts.forEach((part, index) => {
        const partItem = document.createElement('div');
        partItem.className = 'part-config-item';
        partItem.innerHTML = `
          <input type="text" class="part-name-input" value="${part.name}" placeholder="íŒŒíŠ¸ëª…" />
          <input type="number" class="part-min-input" value="${part.min}" min="0" max="50" />
          <span>~</span>
          <input type="number" class="part-max-input" value="${part.max}" min="0" max="50" />
          <button class="save-part-btn" title="ì €ì¥">ğŸ’¾</button>
          <button class="delete-part-btn" title="ì‚­ì œ">Ã—</button>
        `;

        // íŒŒíŠ¸ ì €ì¥ í•¨ìˆ˜
        const savePart = async () => {
          const name = partItem.querySelector('.part-name-input').value.trim();
          const min = parseInt(partItem.querySelector('.part-min-input').value) || 0;
          const max = parseInt(partItem.querySelector('.part-max-input').value) || 0;
          
          const data = loadData();
          data.parts[index] = { name, min, max };
          saveData(data);
          renderParts();
          renderStudentsByParts();
        };

        // íŒŒíŠ¸ ì €ì¥ ë²„íŠ¼
        partItem.querySelector('.save-part-btn').addEventListener('click', savePart);

        // Enter í‚¤ë¡œ ì €ì¥
        partItem.querySelectorAll('input').forEach(input => {
          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              savePart();
            }
          });
        });

        // íŒŒíŠ¸ ì‚­ì œ
        partItem.querySelector('.delete-part-btn').addEventListener('click', async () => {
          const confirmed = await modal.confirm(`"${part.name}" íŒŒíŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 'íŒŒíŠ¸ ì‚­ì œ');
          if (!confirmed) return;
          
          const data = loadData();
          data.parts.splice(index, 1);
          saveData(data);
          renderParts();
          renderStudentsByParts();
        });

        container.appendChild(partItem);
      });
    }

    // íŒ¨ë„ ì´ˆê¸°í™”
    function initStudentPanel() {
      // ëª¨ë‹¬ ì´ˆê¸°í™”
      modal.init();

      // íŒ¨ë„ í† ê¸€
      document.querySelector('#panel-toggle').addEventListener('click', () => {
        document.querySelector('#student-panel').classList.toggle('collapsed');
      });

      // íƒ­ ì „í™˜
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.querySelector(`#${btn.dataset.tab}`).classList.add('active');
        });
      });

      // ë°˜ ì¶”ê°€
      document.querySelector('#add-class-btn').addEventListener('click', async () => {
        const name = await modal.prompt('ë°˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', '', 'ë°˜ ì¶”ê°€');
        if (!name || !name.trim()) return;
        
        const data = loadData();
        const newIndex = data.classes.length;
        data.classes.push({ name: name.trim(), students: [] });
        data.expandedClassIndices.push(newIndex);  // ìƒˆ ë°˜ ìë™ í¼ì¹¨
        data.addToClassIndex = newIndex;  // ìƒˆ ë°˜ì„ ì¶”ê°€ ëŒ€ìƒìœ¼ë¡œ ì„ íƒ
        saveData(data);
        renderStudentsList();
        renderStudentsByParts();
      });

      // ë°˜ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³€ê²½
      document.querySelector('#student-class-select').addEventListener('change', (e) => {
        const data = loadData();
        data.addToClassIndex = e.target.value === '' ? -1 : parseInt(e.target.value);
        saveData(data);
      });

      // í•™ìƒ ì¶”ê°€
      document.querySelector('#add-student-btn').addEventListener('click', async () => {
        const data = loadData();
        const classSelect = document.querySelector('#student-class-select');
        const selectedClassIndex = classSelect.value === '' ? -1 : parseInt(classSelect.value);
        
        if (selectedClassIndex < 0) {
          await modal.alert('í•™ìƒì„ ì¶”ê°€í•  ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        const nameInput = document.querySelector('#student-name-input');
        const valueInput = document.querySelector('#student-value-input');
        const name = nameInput.value.trim();
        const value = parseInt(valueInput.value) || 0;

        if (!name) {
          await modal.alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        data.classes[selectedClassIndex].students.push({ name, value });
        // í•´ë‹¹ ë°˜ì´ í¼ì³ì ¸ ìˆì§€ ì•Šìœ¼ë©´ í¼ì¹˜ê¸°
        if (!data.expandedClassIndices.includes(selectedClassIndex)) {
          data.expandedClassIndices.push(selectedClassIndex);
        }
        saveData(data);
        nameInput.value = '';
        valueInput.value = '';
        renderStudentsList();
        renderStudentsByParts();
      });

      // Enter í‚¤ë¡œ í•™ìƒ ì¶”ê°€
      document.querySelector('#student-name-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.querySelector('#add-student-btn').click();
        }
      });
      document.querySelector('#student-value-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.querySelector('#add-student-btn').click();
        }
      });

      // íŒŒíŠ¸ ì¶”ê°€
      document.querySelector('#add-part-btn').addEventListener('click', () => {
        const data = loadData();
        const lastPart = data.parts[data.parts.length - 1];
        const newMin = lastPart ? lastPart.max + 1 : 1;
        const newMax = Math.min(newMin + 10, 50);
        
        data.parts.push({ name: `íŒŒíŠ¸ ${data.parts.length + 1}`, min: newMin, max: newMax });
        saveData(data);
        renderParts();
        renderStudentsByParts();
      });

      // ì´ˆê¸° ë Œë”ë§
      renderStudentsList();
      renderStudentsByParts();
      renderParts();
    }

    // íŒ¨ë„ ì´ˆê¸°í™”
    initStudentPanel();
  }
</script>
<div id="settings" class="settings">
  <div class="right">
    <div class="row">
      <label for='sltMap'>
        <i class="icon map"></i>
        <span data-trans>Map</span>
      </label>
      <select id="sltMap"></select>
    </div>
    <div class="row">
      <label for='chkAutoRecording'>
        <i class="icon record"></i>
        <span data-trans>Recording</span>
      </label>
      <input type="checkbox" id="chkAutoRecording" />
    </div>
    <div class="row">
      <label>
        <i class="icon trophy"></i>
        <span data-trans>The winner is</span>
      </label>
      <div class="btn-group">
        <button class="btn-winner btn-first-winner active" data-trans>First</button>
        <button class="btn-winner btn-last-winner" data-trans>Last</button>
        <input type="number" id="in_winningRank" value="1" min="1" />
      </div>
    </div>
    <div class="row">
      <label for='chkSkill'>
        <i class="icon bomb"></i>
        <span data-trans>Using skills</span>
      </label>
      <input type="checkbox" id="chkSkill" checked />
      <div class='theme'>
        <i class='icon sun'></i>
        <input type='checkbox' id='chkDarkMode' checked />
        <i class='icon moon'></i>
      </div>
    </div>
  </div>
  <div class="left">
    <h3 data-trans>Enter names below</h3>
    <div id="names-container" class="names-block-container">
      <!-- ì´ë¦„ ë¸”ë¡ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>
    <div class="name-input-row">
      <input type="text" id="name-add-input" placeholder="ì´ë¦„ ì…ë ¥ í›„ Enter" />
      <button id="clear-all-names" class="clear-all-btn" title="ì „ì²´ ì‚­ì œ">ğŸ—‘</button>
    </div>
    <div class="actions">
      <button id="btnNotice">
        <i class="icon megaphone"></i>
      </button>
      <div class="sep"></div>
      <button id="btnReset" title="ëª¨ë“  ì´ë¦„ ì‚­ì œ">
        <i class="icon reset"></i>
        <span>ë¦¬ì…‹</span>
      </button>
      <button id="btnShuffle">
        <i class="icon shuffle"></i>
        <span data-trans>Shuffle</span>
      </button>
      <button id="btnStart">
        <i class="icon play"></i>
        <span data-trans>Start</span>
      </button>
    </div>
  </div>
</div>
<div id="notice">
  <h1>Notice</h1>
  <div class="notice-body">
    <h2>ë§ˆë¸” ë£°ë › 2025ë…„ ê²°ì‚° í˜ì´ì§€ ì˜¤í”ˆ!</h2>
    <p>ğŸ‘‡ğŸ‘‡ ë§ˆë¸” ë£°ë ›ì˜ ì§€ë‚œ 2025ë…„ì„ ëŒì•„ë³´ê³  ì‹¶ë‹¤ë©´ í´ë¦­!</p>
    <p><a href='recap_2025.html' class='recap-button holographic'><img src='assets/2025_recap/recap_large.gif' /></a>
    </p>
  </div>
  <div class="notice-action">
    <button id="closeNotice" data-trans>Close</button>
  </div>
</div>
<!-- ì»¤ìŠ¤í…€ ëª¨ë‹¬ -->
<div id="custom-modal" class="custom-modal">
  <div class="modal-backdrop"></div>
  <div class="modal-container">
    <div class="modal-header">
      <h3 id="modal-title">ì•Œë¦¼</h3>
    </div>
    <div class="modal-body">
      <p id="modal-message"></p>
      <div id="modal-input-area" class="modal-input-area">
        <input type="text" id="modal-input" placeholder="" />
      </div>
    </div>
    <div class="modal-footer">
      <button id="modal-cancel-btn" class="modal-btn cancel">ì·¨ì†Œ</button>
      <button id="modal-confirm-btn" class="modal-btn confirm">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- í•™ìƒ ê´€ë¦¬ íŒ¨ë„ -->
<div id="student-panel" class="collapsed">
  <div id="panel-toggle">
    <span class="toggle-icon">â—€</span>
    <span class="toggle-text">í•™ìƒ ê´€ë¦¬</span>
  </div>
  <div id="panel-content">
    <!-- íƒ­ ë©”ë‰´ -->
    <div class="panel-tabs">
      <button class="tab-btn active" data-tab="class-tab">ë°˜ ê´€ë¦¬</button>
      <button class="tab-btn" data-tab="parts-tab">íŒŒíŠ¸ ì„¤ì •</button>
    </div>

    <!-- ë°˜ ê´€ë¦¬ íƒ­ -->
    <div id="class-tab" class="tab-content active">
      <!-- ë°˜ ì¶”ê°€ ë²„íŠ¼ -->
      <div class="add-class-section">
        <button id="add-class-btn">ìƒˆ ë°˜ ì¶”ê°€</button>
      </div>

      <!-- í•™ìƒ ì¶”ê°€ ì˜ì—­ -->
      <div class="student-add-form">
        <div class="form-row">
          <select id="student-class-select">
            <option value="">-- ë°˜ ì„ íƒ --</option>
          </select>
        </div>
        <div class="form-row">
          <input type="text" id="student-name-input" placeholder="ì´ë¦„" />
          <input type="number" id="student-value-input" placeholder="ìˆ«ì" />
          <button id="add-student-btn">ì¶”ê°€</button>
        </div>
      </div>

      <!-- ë°˜ë³„ í•™ìƒ ëª©ë¡ (ì•„ì½”ë””ì–¸) -->
      <div id="students-list">
        <!-- ë°˜ë³„ í•™ìƒ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
    </div>

    <!-- íŒŒíŠ¸ ì„¤ì • íƒ­ -->
    <div id="parts-tab" class="tab-content">
      <!-- íŒŒíŠ¸ ì„¤ì • ì˜ì—­ -->
      <div class="parts-config-section">
        <h4>íŒŒíŠ¸ ë²”ìœ„ ì„¤ì •</h4>
        <div class="parts-list" id="parts-list">
          <!-- íŒŒíŠ¸ ëª©ë¡ -->
        </div>
        <button id="add-part-btn" class="add-part-btn">+ íŒŒíŠ¸ ì¶”ê°€</button>
      </div>

      <!-- íŒŒíŠ¸ë³„ í•™ìƒ ë¶„ë¥˜ í‘œì‹œ (ëª¨ë“  ë°˜) -->
      <div id="students-by-parts">
        <!-- íŒŒíŠ¸ë³„ë¡œ í•™ìƒì´ í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
    </div>
  </div>
</div>
<div class="copyright">&copy; 2022-2025.<a href="https://lazygyu.net" target="_blank">lazygyu</a> <span data-trans>This program is freeware and may be used freely anywhere, including in broadcasts and videos.</span>
</div>
</body>
</html>
